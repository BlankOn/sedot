#!/usr/bin/env bash

. `dirname $0`/../lib/init.sh
. $BASE/lib/common.sh

PKG=$1

if [ "$PKG" == "" ]; then
	echo_error "Usage: $0 [package]"
	exit 1
fi

TS=`date +%Y%m%d.%H%M%S`
LOGBASE=$BASE/log/sync/$PKG
LOGDIR=$LOGBASE/$TS
PKGDIR=$BASE/pkgs/$PKG

LOG=$LOGDIR/sync.log
STATUS=$LOGDIR/status.txt

if [ ! -d $PKGDIR ]; then
	echo_error "Unknown package: $PKG"
	exit 2
fi

METHOD=`get_value $PKGDIR/method`

#
# Functions
#

write_status () {
	code=$1
	msg=$2

	exec 3>&1
	exec 1>$STATUS

	echo "pkg $PKG"
	echo "name $NAME"
	echo "status $code"
	echo "msg $msg"
	echo "time `date -R`"

	if [ ! -z "$SOURCE" ]; then
		echo "source $SOURCE"
	fi

	exec 1>&3
}

sedot_exit () {
	code=$1

	echo "===== STATUS ====="
	echo "Log directory: $LOGDIR"
	cat $STATUS

	exit $code
}

#
# Preliminary checking
#

# Is sync method supported?

SYNC=$BASE/bin/get.$METHOD

if [ ! -f $SYNC ]; then
	write_status "502" "Unsupported synchronization method: $METHOD"
	sedot_exit 502
fi

# Are source and target specified?

if [ ! -f $PKGDIR/source -o ! -f $PKGDIR/target ]; then
	write_status "503" "Package source and/or target informations are not found."
	sedot_exit 503
fi

#
# Syncronize!
#

NAME=`get_value $PKGDIR/name`
SOURCE=`get_value "$PKGDIR/source"`
TARGET=`get_value "$PKGDIR/target"`

mkdir -p $LOGDIR
STEPFILE=$LOGDIR/step

echo 0 > $STEPFILE

trap 'do_unlock "$TARGET/.SYNC-in-Progress-$HOST"' 1 2 3 6

do_lock $TARGET/.SYNC-in-Progress-$HOST
if [ "$?" -ne "0" ]; then
	write_status "301" "Unable to gain lock"
	sedot_exit 301
fi

rm -f $LOGBASE/current
ln -s $TS $LOGBASE/current

echo "Synchronization begin at `date -R`..."
echo "- Source: $SOURCE"
echo "- Target: $TARGET"
echo "- Method: $METHOD"

TIME_START=`date -R`
write_status "100" "In progress"

(
set +e
export BASE
export SOURCE
export TARGET
export STEPFILE
export LOGDIR
export PKGDIR

$SYNC

echo $? > $LOGDIR/return.txt
) 2>&1 | tee -a $LOG

RET=`cat $LOGDIR/return.txt`
TIME_FINISH=`date -R`

do_unlock $TARGET/.SYNC-in-Progress-$HOST

if [ "$RET" -ne "0" ]; then
	tail -n 20 $LOG > $LOG.last.txt
fi

gzip -9 $LOG

#
# Write status
#

if [ "$RET" -ne "0" ]; then
	write_status "302" "Error"
else
	write_status "200" "Done"
fi

exec 3>&1
exec 1>>$STATUS

echo "code $RET"
echo "step `cat $STEPFILE`"
echo "start $TIME_START"
echo "finish $TIME_FINISH"

exec 1>&3

#
# Call plugins
#

if [ -f $BASE/etc/post-sync-plugins ]; then
	PLUGINDIR=$BASE/plugins

	get_content $BASE/etc/post-sync-plugins | while read plugin
	do

		PLUGIN=$PLUGINDIR/$plugin/$plugin

		if [ -x $PLUGIN ]; then

			(
			set -e

			exec 1>/dev/null
			exec 2>/dev/null
			
			export SEDOT_RETURN=$RET
			export SEDOT_TIME_START=$TIME_START
			export SEDOT_TIME_FINISH=$TIME_FINISH
			export SEDOT_PACKAGE=$PKG
			export SEDOT_NAME=$NAME
			export SEDOT_TIMESTAMP=$TS
			export SEDOT_LOG=$LOG
			export SEDOT_STATUS=$STATUS
			export SEDOT_METHOD=$METHOD
			export SEDOT_BASE=$BASE
			export SEDOT_HOSTNAME=$HOSTNAME
			export SEDOT_SOURCE=$SOURCE
			export SEDOT_TARGET=$TARGET
			export SEDOT_PLUGINDIR=$PLUGINDIR/$plugin

			$PLUGIN
			)

		fi

	done
fi


sedot_exit 0
