#!/usr/bin/env bash

. `dirname $0`/../etc/config.sh

PKG=$1

[ "$PKG" == "" ] && exit 1

TS=`date +%Y%m%d.%H%M%S`
LOGBASE=$BASE/log/sync/$PKG
LOGDIR=$LOGBASE/$TS
PKGDIR=$BASE/pkgs/$PKG

LOG=$LOGDIR/sedot.log
STATUS=$LOGDIR/status.txt

METHOD=`cat $PKGDIR/method`

HOST=`hostname -f`

#
# Functions
#

write_error () {
	code=$1
	msg=$2

	exec 3>&1
	exec 1>$STATUS

	echo "pkg $PKG"
	echo "name $NAME"
	echo "status $code"
	echo "msg $msg"
	echo "time `date -R`"

	exec 1>&3
}

do_lock () {
	TARGET=$1
	LOCK=$TARGET/.SYNC-in-Progress-$HOST
	
	RES=1

	exec 4>&2
	exec 2>/dev/null
	set -o noclobber
	if date -R > $LOCK ; then
		RES=0
	fi
	set +o noclobber
	exec 2>&4

	return $RES
}

do_unlock () {
	TARGET=$1
	LOCK=$TARGET/.SYNC-in-Progress-$HOST
	
	rm -f $LOCK 2> /dev/null
}

#
# Preliminary checking
#

# Does package exist?
mkdir -p $LOGDIR

if [ ! -d $PKGDIR ]; then
	write_error "501" "Unknown package: $PKG"
	exit 501
fi

NAME=`cat $PKGDIR/name`

# Is sync method supported?

SYNC=$BASE/bin/get.$METHOD

if [ ! -f $SYNC ]; then
	write_error "502" "Unsupported synchronization method: $METHOD"
	exit 502
fi

# Are source and target specified?

if [ ! -f $PKGDIR/source -o ! -f $PKGDIR/target ]; then
	write_error "503" "Resource source and/or target informations are not found."
	exit 503
fi

#
# Syncronize!
#

SOURCE=`cat $PKGDIR/source`
TARGET=`cat $PKGDIR/target`
STEPFILE=$LOGDIR/step

echo 0 > $STEPFILE

trap 'do_unlock "$TARGET"' SIGINT

do_lock $TARGET
if [ "$?" -ne "0" ]; then
	write_error "301" "Unable to gain lock"
	exit 301
fi

TIME_START=`date -R`
(
exec 1>$LOG
exec 2>$LOG

set -e
export SOURCE
export TARGET
export STEPFILE
export LOGDIR
export PKGDIR

$SYNC
)
RET=$?
TIME_FINISH=`date -R`

do_unlock $TARGET

if [ "$RET" -ne "0" ]; then
	tail -n 20 $LOG > $LOG.last.txt
fi

gzip -9 $LOG

#
# Write status
#

exec 3>&1
exec 1>$STATUS

echo "pkg $PKG"
echo "name $NAME"

if [ "$RET" -ne "0" ]; then
	echo "status 302"
else
	echo "status 200"
fi

echo "code $RET"
echo "step `cat $STEPFILE`"

echo "start $TIME_START"
echo "finish $TIME_FINISH"

exec 1>&3

#
# Call plugins
#

if [ -f $BASE/etc/post-sync-plugins ]; then
	PLUGINDIR=$BASE/bin/plugins

	cat $BASE/etc/post-sync-plugins | while read plugin
	do

		if [ -x $PLUGINDIR/$plugin ]; then

			(
			set -e

			exec 1>/dev/null
			exec 2>/dev/null
			
			export SEDOT_RETURN=$RET
			export SEDOT_TIME_START=$TIME_START
			export SEDOT_TIME_FINISH=$TIME_FINISH
			export SEDOT_PACKAGE=$PKG
			export SEDOT_NAME=$NAME
			export SEDOT_TIMESTAMP=$TS
			export SEDOT_LOG=$LOG
			export SEDOT_STATUS=$STATUS

			$PLUGINDIR/$plugin
			)

		fi

	done
fi


exit 0
