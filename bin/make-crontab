#!/usr/bin/env bash

. `dirname $0`/../etc/config.sh

NODE=$1

if [ "$NODE" == "" ]; then
	NODE=`hostname -f`
fi

NODEDIR=$BASE/nodes/$NODE
PKGS=$NODEDIR/pkgs
CRON=$BASE/data/cron/$NODE.cron

mkdir -p $NODEDIR
[ -f $PKGS ] || touch $PKGS

exec 3>&1
exec 1>$CRON

echo "### BEGIN SEDOT CRONTAB LIST"
echo
echo "## lines between the SEDOT CRONTAB LIST markers will be modified"
echo "## by the sedot update-crontab script."
echo
echo "## Generated at `date`"
echo
echo "## Node: $NODE"
echo 
echo "SEDOT_BASE=$BASE"
echo

if [ -f $NODEDIR/cron ]; then
	echo "### $NODE's cron"
	echo

	cat $NODEDIR/cron
	echo
fi

echo "### Packages"
echo

cat $PKGS | while read pkg
do
	cron=`cat $BASE/pkgs/$pkg/cron`
	echo "# $pkg"
	echo "$cron \$SEDOT_BASE/bin/sedot $pkg > /dev/null 2>&1"
	echo
done

echo
echo "### END SEDOT CRONTAB LIST"

exec 1>&3

