#!/bin/bash

. `dirname $0`/../lib/init.sh
. $BASE/lib/common.sh

NODE=$1

if [ "$NODE" == "" ]; then
	NODE=$HOST
fi

#
# Functions
#

plot () {

	PKG=$1
	RRD=$RRDBASE/$PKG.rrd

	if [ ! -f "$RRD" ]; then
		return 1;
	fi

	IMGWEEK=$IMGBASE/$PKG.week.png
	IMGMONTH=$IMGBASE/$PKG.month.png
	IMGYEAR=$IMGBASE/$PKG.year.png

	COLOR=`get_color $PKG`
	TITLE=`cat $BASE/pkgs/$PKG/name`

	# Weekly image
	
	rrdtool graph $IMGWEEK \
		--start -1w \
		-l 0 \
		DEF:size=$RRD:size:AVERAGE \
		CDEF:sizeKB=size,1024,* \
		AREA:sizeKB\#${COLOR}88 \
		LINE1:sizeKB\#000000 > /dev/null
	
	# Monthly image
	
	rrdtool graph $IMGMONTH \
		--start -1m \
		-l 0 \
		DEF:size=$RRD:size:AVERAGE \
		CDEF:sizeKB=size,1024,* \
		AREA:sizeKB\#${COLOR}88 \
		LINE1:sizeKB\#000000 > /dev/null
	
	# Anual image
	
	rrdtool graph $IMGYEAR \
		--start -1y \
		-l 0 \
		DEF:size=$RRD:size:AVERAGE \
		CDEF:sizeKB=size,1024,* \
		AREA:sizeKB\#${COLOR}88 \
		LINE1:sizeKB\#000000 > /dev/null
}

#
# Plot graphs
#

PKGS=$BASE/etc/report.pkgs

RRDBASE=$BASE/log/mirror-size
IMGBASE=$BASE/data/report/mirror-size
mkdir -p $IMGBASE

grep -v '^\s*#' $PKGS | while read pkg
do
	plot $pkg
done

#
# Plot combined graph
#

for pkg in `grep -v '^\s*#' $PKGS`
do
	RRD=$RRDBASE/$pkg.rrd
	COLOR=`get_color $pkg`
	TITLE=`cat $BASE/pkgs/$pkg/name`
	PARAM="$PARAM DEF:size-$pkg=$RRD:size:AVERAGE AREA:size-$pkg#${COLOR}:$TITLE:STACK"
done
echo $PARAM

IMGWEEK=$IMGBASE/+all.week.png
IMGMONTH=$IMGBASE/+all.month.png
IMGYEAR=$IMGBASE/+all.year.png

rrdtool graph $IMGWEEK
	--start -1w \
	-l 0 \
	$PARAM

rrdtool graph $IMGMONTH
	--start -1m \
	-l 0 \
	$PARAM

rrdtool graph $IMGYEAR
	--start -1y \
	-l 0 \
	$PARAM
