#!/usr/bin/env bash

. `dirname $0`/../etc/config.sh
. $BASE/lib/common.sh

NODE=$1

if [ "$NODE" == "" ]; then
	NODE=`hostname -f`
fi

#
# Collect usage
#

# Check lock

HOST=`hostname -f`
LOCK=$BASE/data/lock/collect-usage-$HOST

trap 'do_unlock "$LOCK"' SIGINT

do_lock "$LOCK"
if [ "$?" -ne "0" ]; then
	exit 1
fi

# Get usage

NODEDIR=$BASE/nodes/$NODE
PKGS=$NODEDIR/pkgs
PKGBASE=$BASE/pkgs
LOGBASE=$BASE/log/size

mkdir -p $LOGBASE

cat $PKGS | while read pkg
do
	TARGET=`cat $PKGBASE/$pkg/target`
	SIZE=`nice -n 9 du -s $TARGET | awk '{ print $1 }'`
	TIME=`date +%s`

	LOG=$LOGBASE/$pkg.size

	echo "$TIME $SIZE" >> $LOG
done

# Unlock

do_unlock "$LOCK"

